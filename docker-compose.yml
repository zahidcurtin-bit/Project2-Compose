version: '3.8'

services:
  # Docker-in-Docker service - allows Jenkins to build Docker images
  docker:
    image: docker:dind
    container_name: jenkins-docker
    privileged: true  # Required for DinD to work properly
    environment:
      # Enable TLS for secure communication between Jenkins and Docker daemon
      - DOCKER_TLS_CERTDIR=/certs
    volumes:
      # Store Docker TLS certificates for secure communication
      - jenkins-docker-certs:/certs/client
      # Share Jenkins home directory with DinD for data persistence
      - jenkins-data:/var/jenkins_home
    ports:
      # Expose Docker daemon port for remote connections
      - "2376:2376"
    command: --storage-driver=overlay2  # Use overlay2 for better performance
    restart: unless-stopped
    networks:
      jenkins:
        aliases:
          - docker  # Allow Jenkins to connect via hostname 'docker'

  # Jenkins CI/CD server
  jenkins:
    image: jenkins/jenkins:lts-jdk17
    container_name: jenkins
    user: root  # Required to install Docker CLI and manage containers
    ports:
      # Jenkins web interface
      - "8080:8080"
      # Jenkins agent communication port
      - "50000:50000"
    volumes:
      # Persist Jenkins configuration and job data
      - jenkins-data:/var/jenkins_home
      # Mount Docker TLS certificates (read-only) for secure communication
      - jenkins-docker-certs:/certs/client:ro
    environment:
      # Configure Docker client to connect to DinD service
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_CERT_PATH=/certs/client
      - DOCKER_TLS_VERIFY=1
    restart: unless-stopped
    networks:
      - jenkins
    depends_on:
      - docker  # Ensure Docker service starts before Jenkins
    # Custom entrypoint to install Docker CLI inside Jenkins container
    entrypoint: >
      /bin/bash -c "
      echo '=== Installing Docker CLI in Jenkins ===' &&
      apt-get update &&
      apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release &&
      curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg &&
      echo \"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bullseye stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null &&
      apt-get update &&
      apt-get install -y docker-ce-cli &&
      echo '=== Docker CLI installation complete ===' &&
      echo '=== Starting Jenkins ===' &&
      /usr/local/bin/jenkins.sh
      "

# Named volumes for data persistence
volumes:
  # Stores Jenkins configuration, jobs, plugins, and workspace data
  jenkins-data:
    driver: local
  # Stores Docker TLS certificates for secure daemon communication
  jenkins-docker-certs:
    driver: local

# Custom bridge network for service communication
networks:
  jenkins:
    driver: bridge
